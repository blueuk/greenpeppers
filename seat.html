<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¿ˆë“¤ë ˆë°˜ ì¢Œì„ ë°°ì • - ê´€ë¦¬ììš©</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary: #6c5ce7; --yellow: #fdcb6e; --gray: #95a5a6; 
            --bg-color: #f7f1e3; --accent-color: #ffb8b8; --season-icon: 'ğŸŒ¸';
        }
        body.spring { --bg-color: #fff9fb; --accent-color: #ffc1e3; --primary: #d63031; --season-icon: 'ğŸŒ¸'; }
        body.summer { --bg-color: #f0faff; --accent-color: #74b9ff; --primary: #0984e3; --season-icon: 'ğŸŒŠ'; }
        body.autumn { --bg-color: #fffaf0; --accent-color: #fab1a0; --primary: #e17055; --season-icon: 'ğŸ‚'; }
        body.winter { --bg-color: #f1f2f6; --accent-color: #dfe6e9; --primary: #2d3436; --season-icon: 'â„ï¸'; }

        body { 
            font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); 
            background-image: radial-gradient(var(--accent-color) 0.5px, transparent 0.5px);
            background-size: 20px 20px; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; 
            zoom: 1.6; -moz-transform: scale(1.6); -moz-transform-origin: top center; scroll-behavior: smooth;
        }

        @media print {
            body { zoom: 1 !important; -moz-transform: scale(1) !important; background: white !important; padding: 0; background-image: none !important; }
            .setup-card, #fixed-setup-area, #ban-setup-area, #file-info, .btn-start-floating { display: none !important; }
            #classroom-container { transform: rotate(180deg); margin-top: 50px; }
            .teacher-desk, .seat-text, .bundan-title, .row-label { transform: rotate(180deg); display: flex !important; justify-content: center; align-items: center; }
            .teacher-desk { border: 2px solid #000 !important; color: #000 !important; font-weight: bold; width: 200px !important; margin: 0 auto 30px auto !important; }
            .seat { border: 1px solid #000 !important; color: #000 !important; background: white !important; opacity: 1 !important; box-shadow: none !important; }
            .seat.removed { visibility: hidden !important; border: none !important; }
            .bundan { border: 2px solid #000 !important; }
            .row-label { color: #000 !important; left: -90px !important; }
        }

        .setup-card { 
            background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
            width: 95%; max-width: 900px; text-align: center; margin-bottom: 20px; border-top: 5px solid var(--primary);
        }
        
        h1 { color: var(--primary); margin: 0 0 15px 0; font-size: 1.5rem; }
        h1::before { content: var(--season-icon); margin-right: 10px; }
        h1::after { content: var(--season-icon); margin-left: 10px; }
        
        .input-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .input-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        input { padding: 6px; border: 2px solid #dfe6e9; border-radius: 8px; text-align: center; }
        .size-input { width: 40px; }
        .name-input { width: 85px; border-color: #ff7675; }

        #ban-setup-area { 
            display: none; background: #fff5f5; border: 2px solid #ff7675; border-radius: 15px; 
            padding: 15px; margin-bottom: 15px; animation: popIn 0.3s;
        }
        .ban-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; margin: 0 auto; }
        .ban-pair { display: flex; align-items: center; gap: 5px; justify-content: center; background: white; padding: 5px; border-radius: 10px; border: 1px solid #ffb8b8; }
        .ban-label { font-size: 0.7rem; color: #d63031; font-weight: bold; min-width: 45px; }

        .btn-area { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .btn { border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; color: white; transition: all 0.2s ease; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .btn-check { background: #00cec9; }
        .btn-start-floating { background: var(--primary); padding: 8px 15px; font-size: 0.8rem; }
        .btn-reset { background: var(--gray); }
        .btn-print { background: #00b894; }
        .btn-fixed { background: #e84393; font-size: 1.2rem; }
        .btn-ban-toggle { background: #ff7675; font-size: 1.2rem; }
        .btn-danger { background: #ff7675; padding: 5px 10px; font-size: 0.8rem; margin-top: 10px; }
        .btn-file { background: var(--yellow); color: #855e00; width: 100%; max-width: 300px; margin-bottom: 10px; box-shadow: none; }

        #fixed-setup-area { background: rgba(255,255,255,0.95); border: 3px dashed var(--primary); border-radius: 20px; padding: 20px; margin-bottom: 20px; width: 95%; max-width: 900px; display: none; }
        .student-pool { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 10px; border: 1px solid #eee; }
        .student-chip { padding: 5px 12px; background: var(--accent-color); color: white; border-radius: 15px; cursor: grab; font-size: 0.9rem; user-select: none; }

        #classroom-container { width: 100%; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .teacher-area { 
            position: relative; width: 100%; max-width: 600px; height: 60px; 
            display: flex; justify-content: center; align-items: center; margin-bottom: 30px; 
        }
        .teacher-desk { 
            width: 200px; height: 50px; background: white; border-radius: 10px; 
            display: flex; justify-content: center; align-items: center; font-weight: bold; 
            color: var(--primary); border: 2px solid var(--primary); z-index: 1;
        }
        .btn-start-container { position: absolute; right: 0; }

        #classroom { display: flex; flex-wrap: nowrap; justify-content: center; gap: 20px; padding: 20px 20px 20px 80px; }
        .bundan { display: flex; flex-direction: column; gap: 10px; background: white; padding: 10px; border-radius: 15px; border: 2px solid var(--accent-color); position: relative; }
        .bundan-title { font-weight: bold; color: var(--primary); text-align: center; margin-bottom: 5px; }
        .row { display: flex; gap: 8px; justify-content: center; align-items: center; position: relative; }
        
        .row-label {
            position: absolute;
            left: -95px;
            width: 80px;
            text-align: right;
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: bold;
            white-space: nowrap;
        }

        .seat { width: 80px; height: 60px; background: white; border: 1px solid #eee; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1rem; color: #2d3436; position: relative; transition: 0.2s; }
        .seat.empty-seat { cursor: pointer; border: 1px dashed var(--gray); color: var(--gray); font-size: 0.7rem; }
        .seat.empty-seat:hover { background: #ffeaa7; color: #d63031; }
        .seat.empty-seat:hover::after { content: 'ì‚­ì œ'; font-size: 0.5rem; position: absolute; bottom: 5px; }
        .seat.filled { background: var(--primary); color: white; animation: popIn 0.3s forwards; cursor: default; }
        .seat.removed { visibility: hidden; pointer-events: none; }
        .seat.drop-zone { border: 2px dashed var(--primary); background: #f0edff; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body id="seasonBody">

    <div class="setup-card">
        <h1 id="mainTitle">ê¿ˆë“¤ë ˆë°˜ ì¢Œì„ ë°°ì •</h1>
        <button class="btn btn-file" onclick="document.getElementById('fileInput').click()">ğŸ“ ëª…ë‹¨ ì—‘ì…€ íŒŒì¼ ì„ íƒ</button>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        <div id="file-info" style="margin-bottom: 10px; font-size: 0.7rem; color: var(--primary);">íŒŒì¼ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.</div>

        <div class="input-group">
            <div class="input-item"><label>ë¶„ë‹¨</label><input type="number" id="bundanCount" class="size-input" value="3"></div>
            <div class="input-item"><label>ê°€ë¡œ ì§</label><input type="number" id="pairCount" class="size-input" value="2"></div>
            <div class="input-item"><label>ì¤„</label><input type="number" id="rowCount" class="size-input" value="4"></div>
            <button class="btn btn-check" onclick="initEmptyClassroom(true)">âœ… í™•ì¸</button>
        </div>

        <div id="ban-setup-area">
            <div style="margin-bottom:10px; color:#d63031; font-weight:bold; font-size:0.9rem;">âš™ï¸ ğŸ‘¥</div>
            <div class="ban-grid">
                <div class="ban-pair"><span class="ban-label">1ìŒ:</span><input type="text" id="ban1a" class="name-input" placeholder="ì´ë¦„"><input type="text" id="ban1b" class="name-input" placeholder="ì´ë¦„"></div>
                <div class="ban-pair"><span class="ban-label">2ìŒ:</span><input type="text" id="ban2a" class="name-input" placeholder="ì´ë¦„"><input type="text" id="ban2b" class="name-input" placeholder="ì´ë¦„"></div>
                <div class="ban-pair"><span class="ban-label">3ìŒ:</span><input type="text" id="ban3a" class="name-input" placeholder="ì´ë¦„"><input type="text" id="ban3b" class="name-input" placeholder="ì´ë¦„"></div>
                <div class="ban-pair"><span class="ban-label">4ìŒ:</span><input type="text" id="ban4a" class="name-input" placeholder="ì´ë¦„"><input type="text" id="ban4b" class="name-input" placeholder="ì´ë¦„"></div>
            </div>
        </div>

        <div class="btn-area">
            <button class="btn btn-ban-toggle" title="ì¸ì ‘ ê¸ˆì§€ ì„¤ì •" onclick="toggleBanMode()">âš™ï¸</button>
            <button class="btn btn-fixed" title="ì§€ì •ì„ ì„¤ì •" onclick="toggleFixedMode()">ğŸµï¸</button>
            <button class="btn btn-reset" onclick="resetPlacementOnly(true)">ğŸ”„ ì´ˆê¸°í™”</button>
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ì¸ì‡„</button>
        </div>
    </div>

    <div id="fixed-setup-area">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color:var(--primary); margin:0;">ğŸ“ ì§€ì • ì¢Œì„ ë°°ì¹˜ ëª¨ë“œ</h3>
            <button class="btn btn-danger" onclick="clearFixedMap()">âš ï¸ ì§€ì •ì„ ì „ì²´ ì‚­ì œ</button>
        </div>
        <div id="student-pool" class="student-pool"></div>
        <div id="fixed-classroom-grid" style="display: flex; justify-content: center; gap: 20px; margin-top:10px; padding-left:140px;"></div>
    </div>

    <div id="classroom-container">
        <div class="teacher-area">
            <div class="teacher-desk">ğŸ“º ì¹ íŒ / ì„ ìƒë‹˜ ì±…ìƒ</div>
            <div class="btn-start-container">
                <button class="btn btn-start-floating" onclick="handleAssignClick(event)">ğŸš€ ëœë¤ ìë¦¬ ë°°ì¹˜!</button>
            </div>
        </div>
        <div id="classroom"></div>
    </div>

<script>
    let studentList = [];
    let fixedMap = {}; 
    let removedSeatIndices = new Set();
    let lastFinalAssignment = {}; 

    const rowNames = ["ì²«ì§¸ì¤„", "ë‘˜ì§¸ì¤„", "ì…‹ì§¸ì¤„", "ë„·ì§¸ì¤„", "ë‹¤ì„¯ì§¸ì¤„", "ì—¬ì„¯ì§¸ì¤„", "ì¼ê³±ì§¸ì¤„", "ì—¬ëŸì§¸ì¤„"];

    function saveData() {
        const data = {
            studentList,
            fixedMap,
            removedSeatIndices: Array.from(removedSeatIndices),
            lastFinalAssignment,
            bundanCount: document.getElementById('bundanCount').value,
            pairCount: document.getElementById('pairCount').value,
            rowCount: document.getElementById('rowCount').value
        };
        localStorage.setItem('dreamleData', JSON.stringify(data));
    }

    function loadData() {
        const saved = localStorage.getItem('dreamleData');
        if (!saved) return;
        const data = JSON.parse(saved);
        studentList = data.studentList || [];
        fixedMap = data.fixedMap || {};
        removedSeatIndices = new Set(data.removedSeatIndices || []);
        lastFinalAssignment = data.lastFinalAssignment || {};
        document.getElementById('bundanCount').value = data.bundanCount || 3;
        document.getElementById('pairCount').value = data.pairCount || 2;
        document.getElementById('rowCount').value = data.rowCount || 4;
        
        if (studentList.length > 0) {
            document.getElementById('file-info').innerText = `âœ… ì´ ${studentList.length}ëª… ë¡œë“œ ì™„ë£Œ (ë³µêµ¬ë¨)`;
            renderClassroomFromSaved();
        }
    }

    function renderClassroomFromSaved() {
        initEmptyClassroom(false); 
        const allSeats = document.querySelectorAll('#classroom .seat');
        allSeats.forEach(seat => {
            const idx = seat.dataset.idx;
            const name = lastFinalAssignment[idx];
            if (name) {
                seat.innerHTML = `<span class="seat-text">${name}</span>`;
                seat.className = 'seat filled';
            }
        });
    }

    function playFanfare() {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playNote(freq, start, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'triangle'; osc.frequency.setValueAtTime(freq, start);
            gain.gain.setValueAtTime(0.3, start); gain.gain.exponentialRampToValueAtTime(0.01, start + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(start); osc.stop(start + duration);
        }
        const now = audioCtx.currentTime;
        playNote(392.00, now, 0.1); playNote(523.25, now + 0.15, 0.4); 
    }

    function setSeason() {
        const month = new Date().getMonth() + 1;
        const body = document.getElementById('seasonBody');
        const title = document.getElementById('mainTitle');
        let season = (month >= 3 && month <= 5) ? 'spring' : (month >= 6 && month <= 8) ? 'summer' : (month >= 9 && month <= 11) ? 'autumn' : 'winter';
        let text = (month >= 3 && month <= 5) ? 'ë´„ë§ì´' : (month >= 6 && month <= 8) ? 'ì‹œì›í•œ ì—¬ë¦„' : (month >= 9 && month <= 11) ? 'í’ì„±í•œ ê°€ì„' : 'í¬ê·¼í•œ ê²¨ìš¸';
        body.className = season; 
        title.innerText = `${text} ê¿ˆë“¤ë ˆë°˜ ì¢Œì„ ë°°ì •`;
    }
    setSeason();

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let names = [];
            for(let r = 4; r <= 100; r++) { 
                const cell = sheet[XLSX.utils.encode_cell({r: r, c: 2})];
                if(cell && cell.v) names.push(String(cell.v).trim());
            }
            studentList = names;
            document.getElementById('file-info').innerText = `âœ… ì´ ${studentList.length}ëª… ë¡œë“œ ì™„ë£Œ`;
            
            const bCount = parseInt(document.getElementById('bundanCount').value);
            const pCount = parseInt(document.getElementById('pairCount').value);
            const neededRows = Math.ceil(studentList.length / (bCount * pCount));
            document.getElementById('rowCount').value = Math.max(4, neededRows);
            
            initEmptyClassroom(true);
        };
        reader.readAsArrayBuffer(file);
    });

    function initEmptyClassroom(isReset) {
        if (isReset) { removedSeatIndices.clear(); fixedMap = {}; lastFinalAssignment = {}; }
        const bCount = parseInt(document.getElementById('bundanCount').value);
        const pCount = parseInt(document.getElementById('pairCount').value);
        const totalRows = parseInt(document.getElementById('rowCount').value);
        const classroom = document.getElementById('classroom');
        classroom.innerHTML = "";

        for (let i = 0; i < bCount; i++) {
            const bDiv = document.createElement('div');
            bDiv.className = 'bundan';
            bDiv.innerHTML = `<div class="bundan-title">${i + 1}ë¶„ë‹¨</div>`;
            for (let r = 0; r < totalRows; r++) {
                const rDiv = document.createElement('div');
                rDiv.className = 'row';
                
                if (i === 0) {
                    const label = document.createElement('div');
                    label.className = 'row-label';
                    label.innerText = rowNames[r] || `${r+1}ì§¸ì¤„`;
                    rDiv.appendChild(label);
                }

                for (let p = 0; p < pCount; p++) {
                    const seat = document.createElement('div');
                    const seatIdx = String((r * bCount * pCount) + (i * pCount) + p);
                    seat.className = removedSeatIndices.has(seatIdx) ? 'seat removed' : 'seat empty-seat';
                    seat.dataset.idx = seatIdx;
                    seat.dataset.r = r; seat.dataset.b = i; seat.dataset.p = p; 
                    seat.innerHTML = `<span class="seat-text">ë¹ˆìë¦¬</span>`;
                    
                    seat.onclick = function() { 
                        if (this.classList.contains('filled')) return;
                        const idx = this.dataset.idx;
                        if(fixedMap[idx]) delete fixedMap[idx];
                        this.classList.add('removed'); 
                        removedSeatIndices.add(idx);
                        if(document.getElementById('fixed-setup-area').style.display === 'block') renderFixedSetup();
                        saveData();
                    };
                    rDiv.appendChild(seat);
                }
                bDiv.appendChild(rDiv);
            }
            classroom.appendChild(bDiv);
        }
        if (isReset) saveData();
    }

    function resetPlacementOnly(manual) {
        lastFinalAssignment = {};
        const allSeats = document.querySelectorAll('#classroom .seat');
        allSeats.forEach(seat => {
            if (!seat.classList.contains('removed')) {
                seat.className = 'seat empty-seat';
                seat.innerHTML = `<span class="seat-text">ë¹ˆìë¦¬</span>`;
            }
        });
        if(manual) saveData();
    }

    function toggleBanMode() {
        const area = document.getElementById('ban-setup-area');
        area.style.display = (area.style.display === 'block') ? 'none' : 'block';
    }

    function toggleFixedMode() {
        const area = document.getElementById('fixed-setup-area');
        if (studentList.length === 0) return alert("í•™ìƒ ëª…ë‹¨ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
        area.style.display = (area.style.display === 'block') ? 'none' : 'block';
        if (area.style.display === 'block') renderFixedSetup();
    }

    function renderFixedSetup() {
        const pool = document.getElementById('student-pool');
        const grid = document.getElementById('fixed-classroom-grid');
        const bCount = parseInt(document.getElementById('bundanCount').value);
        const pCount = parseInt(document.getElementById('pairCount').value);
        const totalRows = parseInt(document.getElementById('rowCount').value);
        pool.innerHTML = "";
        const assignedStudents = Object.values(fixedMap);
        studentList.filter(s => !assignedStudents.includes(s)).forEach(name => {
            const chip = document.createElement('div'); chip.className = 'student-chip'; chip.innerText = name; chip.draggable = true;
            chip.ondragstart = (e) => e.dataTransfer.setData("text", name); pool.appendChild(chip);
        });
        grid.innerHTML = "";
        for (let i = 0; i < bCount; i++) {
            const bundan = document.createElement('div'); bundan.className = 'bundan';
            bundan.innerHTML = `<div class="bundan-title" style="font-size:0.7rem;">${i + 1}ë¶„ë‹¨</div>`;
            for (let r = 0; r < totalRows; r++) {
                const row = document.createElement('div'); row.className = 'row';

                if (i === 0) {
                    const label = document.createElement('div');
                    label.className = 'row-label';
                    label.style.left = "-130px"; // ì»¤ì§„ í¬ê¸°ì— ë§ì¶° ë ˆì´ë¸” ìœ„ì¹˜ ì¡°ì •
                    label.style.fontSize = "0.75rem"; 
                    label.innerText = rowNames[r] || `${r+1}ì§¸ì¤„`;
                    row.appendChild(label);
                }

                for (let p = 0; p < pCount; p++) {
                    const idx = String((r * bCount * pCount) + (i * pCount) + p);
                    const seat = document.createElement('div');
                    
                    if (removedSeatIndices.has(idx)) {
                        seat.className = 'seat removed';
                        // ì§€ì •ì„ ëª¨ë“œ ì „ìš© 1.3ë°° í™•ëŒ€ í¬ê¸° (ê¸°ì¡´ 60*40 -> 78*52)
                        seat.style.width = "78px"; seat.style.height = "52px";
                    } else {
                        seat.className = 'seat' + (fixedMap[idx] ? ' filled' : ' empty-seat');
                        seat.style.width = "78px"; seat.style.height = "52px"; seat.style.fontSize = "0.85rem";
                        seat.innerHTML = `<span class="seat-text">${fixedMap[idx] || "ì§€ì •ì„"}</span>`;
                        seat.ondragover = (e) => { e.preventDefault(); seat.classList.add('drop-zone'); };
                        seat.ondragleave = () => seat.classList.remove('drop-zone');
                        seat.ondrop = (e) => { e.preventDefault(); fixedMap[idx] = e.dataTransfer.getData("text"); renderFixedSetup(); saveData(); };
                        seat.onclick = () => { if(fixedMap[idx]) { delete fixedMap[idx]; renderFixedSetup(); saveData(); } };
                    }
                    row.appendChild(seat);
                }
                bundan.appendChild(row);
            }
            grid.appendChild(bundan);
        }
    }

    function clearFixedMap() { if(confirm("ë°°ì¹˜ëœ ëª¨ë“  ì§€ì • ì¢Œì„ ì •ë³´ë¥¼ ì‚­ì œí• ê¹Œìš”?")) { fixedMap = {}; renderFixedSetup(); saveData(); } }
    function handleAssignClick(event) { assignSeats(event.ctrlKey); }

    function isAdjacent(seatA, seatB) {
        if (!seatA || !seatB) return false;
        const r1 = parseInt(seatA.r), b1 = parseInt(seatA.b), p1 = parseInt(seatA.p);
        const r2 = parseInt(seatB.r), b2 = parseInt(seatB.b), p2 = parseInt(seatB.p);
        const pCount = parseInt(document.getElementById('pairCount').value);
        if (b1 === b2) return Math.abs(r1 - r2) <= 1 && Math.abs(p1 - p2) <= 1;
        if (Math.abs(b1 - b2) === 1 && Math.abs(r1 - r2) <= 1) {
            if ((b1 < b2 && p1 === (pCount-1) && p2 === 0) || (b1 > b2 && p1 === 0 && p2 === (pCount-1))) return true;
        }
        return false;
    }

    function assignSeats(useFixed) {
        if (studentList.length === 0) return alert("ëª…ë‹¨ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!");
        const banPairs = [];
        for(let i=1; i<=4; i++) {
            const a = document.getElementById(`ban${i}a`).value.trim();
            const b = document.getElementById(`ban${i}b`).value.trim();
            if(a && b) banPairs.push([a, b]);
        }
        const availableSeats = Array.from(document.querySelectorAll('#classroom .seat:not(.removed)'));
        if (availableSeats.length < studentList.length) return alert(`ì¢Œì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! 'ì¤„' ìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì„¸ìš”.`);
        
        let finalAssignment = null;
        let attempts = 0;
        while (attempts < 500) {
            attempts++;
            let currentTry = {};
            let remainingStudents = [];
            if (useFixed) {
                const assigned = Object.values(fixedMap);
                remainingStudents = studentList.filter(n => !assigned.includes(n)).sort(() => Math.random() - 0.5);
            } else {
                remainingStudents = [...studentList].sort(() => Math.random() - 0.5);
            }
            let remainIdx = 0;
            let studentPositions = {};
            availableSeats.forEach(seat => {
                const idx = seat.dataset.idx;
                let name = (useFixed && fixedMap[idx]) ? fixedMap[idx] : (remainIdx < remainingStudents.length ? remainingStudents[remainIdx++] : "");
                if (name) { currentTry[idx] = name; studentPositions[name] = seat.dataset; }
            });
            let conflict = false;
            for (const [p1, p2] of banPairs) {
                if (studentPositions[p1] && studentPositions[p2] && isAdjacent(studentPositions[p1], studentPositions[p2])) {
                    conflict = true; break;
                }
            }
            if (conflict) continue;
            finalAssignment = currentTry;
            break;
        }
        if (!finalAssignment) return alert("ì¸ì ‘ ê¸ˆì§€ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ë°°ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        
        lastFinalAssignment = finalAssignment; 
        availableSeats.forEach(seat => {
            const name = finalAssignment[seat.dataset.idx];
            if (name) { seat.innerHTML = `<span class="seat-text">${name}</span>`; seat.className = 'seat filled'; }
            else { seat.innerHTML = `<span class="seat-text">ë¹ˆìë¦¬</span>`; seat.className = 'seat empty-seat'; }
        });
        saveData(); 
        playFanfare();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        setTimeout(() => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }, 100);
    }

    window.onload = function() { loadData(); };
</script>
</body>
</html>