<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futsal Scout PRO v4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2fe; --secondary: #4facfe; --bg-dark: #0f111a;
            --card-bg: #1e2130; --text-main: #ffffff; --text-dim: #a0aec0;
            --pos-gol: #f6ad55; --pos-ala: #4fd1c5; --pos-fix: #f687b3; --pos-piv: #63b3ed;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 10px; }
        .container { width: 100%; max-width: 900px; margin: 0 auto; }
        .header-panel { background: var(--card-bg); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-label { font-size: 0.7rem; color: var(--text-dim); padding-left: 4px; }
        select, input { background: #0b0d14; border: 1px solid #444; color: white; padding: 10px; border-radius: 10px; font-size: 0.85rem; }
        .drop-zone { background: rgba(255,255,255,0.02); border: 2px dashed #444; border-radius: 15px; padding: 12px; min-height: 80px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .player-item { background: #2d3446; padding: 10px 5px; border-radius: 10px; text-align: center; font-size: 0.8rem; border: 1px solid #3d455d; cursor: pointer; }
        .player-item.active { border-color: var(--primary); background: rgba(0, 242, 254, 0.1); }
        .btn-generate { background: linear-gradient(45deg, var(--secondary), var(--primary)); border: none; padding: 16px; border-radius: 14px; font-weight: 800; width: 100%; margin-top: 15px; cursor: pointer; }
        .team-card { background: var(--card-bg); border-radius: 20px; padding: 15px; margin-top: 15px; border-top: 4px solid var(--secondary); }
        .member-row { display: flex; justify-content: space-between; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-top: 5px; font-size: 0.85rem; }
        .pos-badge { font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; color: #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-panel">
        <div style="text-align: center; font-weight: 800; color: var(--primary);">FUTSAL TEAM GENERATOR v4.0</div>
        <div id="statusMsg" style="text-align:center; font-size:0.7rem; margin:5px 0;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        <div class="config-row">
            <div class="input-group">
                <span class="input-label">ë§¤ì¹˜ ëª¨ë“œ</span>
                <select id="matchMode" onchange="calcTeams()"><option value="5">5 vs 5</option><option value="6" selected>6 vs 6</option></select>
            </div>
            <div class="input-group">
                <span class="input-label">ìš©ë³‘ ì¸ì›</span>
                <input type="number" id="mercCount" value="0" min="0" onchange="calcTeams()">
            </div>
        </div>
        <div id="teamCalcInfo" style="font-size: 0.75rem; color: var(--text-dim); margin-top: 8px; text-align: center;"></div>
    </div>

    <div style="font-size: 0.8rem; color: var(--secondary); margin: 10px 0 5px;">ğŸ‘¥ ë¯¸ì°¸ì—¬ (<span id="pCount">0</span>)</div>
    <div id="poolZone" class="drop-zone"></div>

    <div style="font-size: 0.8rem; color: var(--primary); margin: 15px 0 5px;">âœ… ì˜¤ëŠ˜ ì°¸ì—¬ (<span id="aCount">0</span>)</div>
    <div id="activeZone" class="drop-zone"></div>

    <button class="btn-generate" onclick="generateTeams()">ì „ëµì  íŒ€ ë°°ì • ì‹œì‘</button>
    <div id="resultArea"></div>
</div>

<script>
    let players = [];
    const RIVALS = ["ê¹€ë™ì„­", "ì„ì •í˜„"];
    const FIXED_GOL = ["ì„ì •í˜„", "ê¹€í˜„ì›…"];

    async function loadData() {
        const url = 'https://blueuk.github.io/greenpeppers/makeTeam/players.txt';
        try {
            const res = await fetch(url);
            const text = await res.text();
            players = text.trim().split('\n').filter(l => l.includes('|')).map((l, i) => {
                const [n, g, a, f, p] = l.split('|');
                return { 
                    name: n.trim(), gol: +g, ala: +a, fix: +f, piv: +p, 
                    avg: (+g + +a + +f + +p) / 4, status: 'pool'
                };
            });
            document.getElementById('statusMsg').innerText = `ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${players.length}ëª…`;
            render();
        } catch (e) { document.getElementById('statusMsg').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"; }
    }

    function render() {
        const pz = document.getElementById('poolZone'), az = document.getElementById('activeZone');
        pz.innerHTML = az.innerHTML = "";
        players.sort((a,b)=>a.name.localeCompare(b.name, 'ko')).forEach(p => {
            const d = document.createElement('div');
            d.className = 'player-item';
            d.onclick = () => { p.status = (p.status === 'pool' ? 'active' : 'pool'); render(); calcTeams(); };
            d.innerHTML = `<b>${p.name}</b>`;
            if (p.status === 'active') az.appendChild(d); else pz.appendChild(d);
        });
        document.getElementById('aCount').innerText = players.filter(v=>v.status==='active').length;
        document.getElementById('pCount').innerText = players.filter(v=>v.status==='pool').length;
        calcTeams();
    }

    function calcTeams() {
        const activeCount = players.filter(p => p.status === 'active').length + (+document.getElementById('mercCount').value);
        const perTeam = +document.getElementById('matchMode').value;
        const teams = Math.floor(activeCount / perTeam);
        const rem = activeCount % perTeam;
        document.getElementById('teamCalcInfo').innerText = `ì´ ${activeCount}ëª… ì°¸ì—¬ -> ${teams}ê°œ íŒ€ ìƒì„± ê°€ëŠ¥ (ì‰ì—¬: ${rem}ëª…)`;
        return { teams, perTeam, rem };
    }

    function generateTeams() {
        const info = calcTeams();
        if (info.teams < 2) return alert("ìµœì†Œ 2íŒ€ ì´ìƒ êµ¬ì„± ê°€ëŠ¥í•œ ì¸ì›ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        let activePool = players.filter(p => p.status === 'active').map(p => ({...p, assigned: false}));
        const mercCount = +document.getElementById('mercCount').value;
        if (mercCount > 0) {
            const avgVal = activePool.reduce((a,c)=>a+c.avg,0)/activePool.length;
            for(let i=1; i<=mercCount; i++) activePool.push({ name: `ìš©ë³‘${i}`, gol:avgVal, ala:avgVal, fix:avgVal, piv:avgVal, avg:avgVal, assigned:false, isMerc:true });
        }

        let teams = Array.from({length: info.teams}, (_, i) => ({ id: i+1, members: [], totalScore: 0 }));

        const getTargetTeam = (player) => {
            // [ì œì•½ 1] ê¹€ë™ì„­/ì„ì •í˜„ ë¶„ë¦¬
            let availableTeams = [...teams].sort((a,b) => a.totalScore - b.totalScore);
            if (RIVALS.includes(player.name)) {
                const rivalName = RIVALS.find(n => n !== player.name);
                availableTeams = availableTeams.filter(t => !t.members.some(m => m.name === rivalName));
            }
            return availableTeams[0];
        };

        const assignStep = (sortKey, countPerTeam) => {
            let candidates = activePool.filter(p => !p.assigned && !FIXED_GOL.includes(p.name))
                                       .sort((a,b) => b[sortKey] - a[sortKey])
                                       .slice(0, info.teams * countPerTeam);
            // ì…”í”Œí•˜ì—¬ êµì°¨ ë¶„ë°°
            candidates.sort(() => Math.random() - 0.5).forEach(p => {
                let t = getTargetTeam(p);
                if(!t) t = [...teams].sort((a,b) => a.totalScore - b.totalScore)[0]; // ê°•ì œ ë°°ì •
                p.assigned = true; t.members.push(p); t.totalScore += p.avg;
            });
        };

        // 1. í”½ì†Œ (íŒ€ë‹¹ 2)
        assignStep('fix', 2);
        // 2. ì•„ë¼ (6:6ì€ 2ëª…, 5:5ëŠ” 1ëª…)
        assignStep('ala', info.perTeam === 6 ? 2 : 1);
        // 3. í”¼ë³´ (íŒ€ë‹¹ 1)
        assignStep('piv', 1);

        // 4. ê³¨ë ˆì´ (ê³ ì • ì¸ì› ì²˜ë¦¬ í¬í•¨)
        let fixedGols = activePool.filter(p => FIXED_GOL.includes(p.name));
        fixedGols.forEach(p => {
            let t = getTargetTeam(p);
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        // ë‚¨ì€ ê³¨ë ˆì´ í›„ë³´
        let remainGols = activePool.filter(p => !p.assigned).sort((a,b) => b.gol - a.gol).slice(0, Math.max(0, info.teams - fixedGols.length));
        remainGols.forEach(p => {
            let t = getTargetTeam(p);
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        // 5. ì‰ì—¬ ì¸ì› ë°°ì • (ìë¦¬ ë‚¨ì€ íŒ€ + ì ìˆ˜ ë‚®ì€ íŒ€ ìˆœ)
        activePool.filter(p => !p.assigned).sort((a,b) => b.avg - a.avg).forEach(p => {
            let t = [...teams].filter(v => v.members.length < info.perTeam).sort((a,b) => a.totalScore - b.totalScore)[0];
            if (!t) t = [...teams].sort((a,b) => a.totalScore - b.totalScore)[0]; // ì™„ì „ ì‰ì—¬
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        display(teams);
    }

    function display(teams) {
        const area = document.getElementById('resultArea'); area.innerHTML = "";
        teams.forEach(t => {
            const card = document.createElement('div'); card.className = 'team-card';
            const mHtml = t.members.map(m => {
                const b = [{n:'GOL',v:m.gol,c:'f6ad55'},{n:'ALA',v:m.ala,c:'4fd1c5'},{n:'FIX',v:m.fix,c:'f687b3'},{n:'PIV',v:m.piv,c:'63b3ed'}].sort((a,b)=>b.v-a.v)[0];
                return `<div class="member-row"><span>${m.name}</span><span class="pos-badge" style="background:#${b.c}">${b.n} ${b.v.toFixed(1)}</span></div>`;
            }).join('');
            card.innerHTML = `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:5px; font-weight:800;"><span>TEAM ${t.id}</span><span style="color:var(--primary)">${t.totalScore.toFixed(1)}</span></div>${mHtml}`;
            area.appendChild(card);
        });
    }

    window.onload = loadData;
</script>
</body>
</html>
