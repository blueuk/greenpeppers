<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Futsal Scout PRO v4.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2fe; --secondary: #4facfe; --bg-dark: #0f111a;
            --card-bg: #1e2130; --text-main: #ffffff; --text-dim: #a0aec0;
            --pos-gol: #f6ad55; --pos-ala: #4fd1c5; --pos-fix: #f687b3; --pos-piv: #63b3ed;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-dark); color: var(--text-main); margin: 0; padding: 10px; -webkit-user-select:none; user-select:none; }
        .container { width: 100%; max-width: 900px; margin: 0 auto; }
        .header-panel { background: var(--card-bg); padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .input-group { display: flex; flex-direction: column; gap: 4px; }
        .input-label { font-size: 0.7rem; color: var(--text-dim); padding-left: 4px; }
        select, input { background: #0b0d14; border: 1px solid #444; color: white; padding: 10px; border-radius: 10px; font-size: 0.85rem; outline: none; }
        .drop-zone { background: rgba(255,255,255,0.02); border: 2px dashed #444; border-radius: 15px; padding: 12px; min-height: 80px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .player-item { background: #2d3446; padding: 10px 5px; border-radius: 10px; text-align: center; font-size: 0.8rem; border: 1px solid #3d455d; cursor: pointer; transition: 0.2s; }
        .player-item:hover { border-color: var(--primary); background: #3d455d; }
        .btn-generate { background: linear-gradient(45deg, var(--secondary), var(--primary)); border: none; padding: 18px; border-radius: 14px; font-weight: 800; width: 100%; margin-top: 15px; cursor: pointer; color: #000; font-size: 1rem; }
        .team-card { background: var(--card-bg); border-radius: 20px; padding: 15px; margin-top: 15px; border-top: 4px solid var(--secondary); }
        .member-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-top: 5px; font-size: 0.85rem; }
        .pos-badge { font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; font-weight: 800; color: #000; text-transform: uppercase; }
        #statusMsg { text-align: center; font-size: 0.75rem; color: var(--primary); margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-panel">
        <div style="text-align: center; font-weight: 800; color: var(--primary); letter-spacing: 1px;">FUTSAL GENERATOR PRO v4.5</div>
        <div id="statusMsg">ë°ì´í„° ë¡œë“œ ëŒ€ê¸° ì¤‘...</div>
        <div class="config-row">
            <div class="input-group">
                <span class="input-label">ë§¤ì¹˜ ëª¨ë“œ</span>
                <select id="matchMode" onchange="calcTeams()"><option value="5">5 vs 5</option><option value="6" selected>6 vs 6</option></select>
            </div>
            <div class="input-group">
                <span class="input-label">ìš©ë³‘ ì¸ì›</span>
                <input type="number" id="mercCount" value="0" min="0" onchange="calcTeams()">
            </div>
        </div>
        <div id="teamCalcInfo" style="font-size: 0.7rem; color: var(--text-dim); margin-top: 10px; text-align: center; border-top: 1px solid #333; padding-top: 8px;"></div>
    </div>

    <div style="font-size: 0.8rem; color: var(--secondary); margin: 10px 0 5px; font-weight: 600;">ğŸ‘¥ ë¯¸ì°¸ì—¬ ëª…ë‹¨ (<span id="pCount">0</span>)</div>
    <div id="poolZone" class="drop-zone"></div>

    <div style="font-size: 0.8rem; color: var(--primary); margin: 15px 0 5px; font-weight: 600;">âœ… ì˜¤ëŠ˜ ì°¸ì—¬ í™•ì • (<span id="aCount">0</span>)</div>
    <div id="activeZone" class="drop-zone"></div>

    <button class="btn-generate" onclick="generateTeams()">ì „ëµì  íŒ€ ë°°ì • ì‹œì‘</button>
    <div id="resultArea"></div>
</div>

<script>
    let players = [];

    // [ìµœìš°ì„  ì œì•½ ì¡°ê±´ ì„¤ì •]
    const RIVALS_MAP = {
        "ì„ì •í˜„": ["ê¹€ë™ì„­", "ê¹€í˜„ì›…"],
        "ê¹€ë™ì„­": ["ì„ì •í˜„"],
        "ê¹€í˜„ì›…": ["ì„ì •í˜„"]
    };
    const FIXED_GOL = ["ì„ì •í˜„", "ê¹€í˜„ì›…"];

    async function loadData() {
        const url = 'https://blueuk.github.io/greenpeppers/makeTeam/players.txt';
        try {
            const res = await fetch(url);
            const text = await res.text();
            players = text.trim().split('\n').filter(l => l.includes('|')).map((l, i) => {
                const [n, g, a, f, p] = l.split('|');
                return { 
                    name: n.trim(), gol: +g, ala: +a, fix: +f, piv: +p, 
                    avg: (+g + +a + +f + +p) / 4, status: 'pool'
                };
            });
            document.getElementById('statusMsg').innerText = `âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${players.length}ëª…)`;
            render();
        } catch (e) { 
            document.getElementById('statusMsg').innerText = "âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        }
    }

    function render() {
        const pz = document.getElementById('poolZone'), az = document.getElementById('activeZone');
        pz.innerHTML = az.innerHTML = "";
        players.sort((a,b)=>a.name.localeCompare(b.name, 'ko')).forEach(p => {
            const d = document.createElement('div');
            d.className = 'player-item';
            d.onclick = () => { p.status = (p.status === 'pool' ? 'active' : 'pool'); render(); };
            d.innerHTML = `<b>${p.name}</b>`;
            if (p.status === 'active') az.appendChild(d); else pz.appendChild(d);
        });
        document.getElementById('aCount').innerText = players.filter(v=>v.status==='active').length;
        document.getElementById('pCount').innerText = players.filter(v=>v.status==='pool').length;
        calcTeams();
    }

    function calcTeams() {
        const activeCount = players.filter(p => p.status === 'active').length + (+document.getElementById('mercCount').value);
        const perTeam = +document.getElementById('matchMode').value;
        const teams = Math.floor(activeCount / perTeam);
        const rem = activeCount % perTeam;
        document.getElementById('teamCalcInfo').innerText = `í˜„ì¬ ${activeCount}ëª… ì°¸ì—¬ ì¤‘ â†’ ${teams}íŒ€ êµ¬ì„± ê°€ëŠ¥ (ì‰ì—¬: ${rem}ëª…)`;
        return { teams, perTeam, rem };
    }

    function generateTeams() {
        const info = calcTeams();
        if (info.teams < 2) return alert("ìµœì†Œ 2ê°œ íŒ€ì´ í•„ìš”í•©ë‹ˆë‹¤.");

        let activePool = players.filter(p => p.status === 'active').map(p => ({...p, assigned: false}));
        const mercCount = +document.getElementById('mercCount').value;
        if (mercCount > 0) {
            const avgVal = activePool.length > 0 ? activePool.reduce((a,c)=>a+c.avg,0)/activePool.length : 50;
            for(let i=1; i<=mercCount; i++) activePool.push({ name: `ìš©ë³‘${i}`, gol:avgVal, ala:avgVal, fix:avgVal, piv:avgVal, avg:avgVal, assigned:false, isMerc:true });
        }

        let teams = Array.from({length: info.teams}, (_, i) => ({ id: i+1, members: [], totalScore: 0 }));

        // [ìˆ™ì  ë¶„ë¦¬ í•µì‹¬ ë¡œì§]
        const getTargetTeam = (player) => {
            let availableTeams = [...teams].sort((a,b) => a.totalScore - b.totalScore);
            
            if (RIVALS_MAP[player.name]) {
                const myRivals = RIVALS_MAP[player.name];
                // ë‚´ ìˆ™ì ì´ ì´ë¯¸ í¬í•¨ëœ íŒ€ì€ ì„ íƒì§€ì—ì„œ ì œì™¸
                availableTeams = availableTeams.filter(t => !t.members.some(m => myRivals.includes(m.name)));
            }
            
            // ëª¨ë“  íŒ€ì— ìˆ™ì ì´ ìˆì„ ê²½ìš° ê°€ì¥ ì ìˆ˜ ë‚®ì€ íŒ€ì— ë°°ì •
            return availableTeams.length > 0 ? availableTeams[0] : [...teams].sort((a,b) => a.totalScore - b.totalScore)[0];
        };

        const assignStep = (sortKey, countPerTeam) => {
            let candidates = activePool.filter(p => !p.assigned && !FIXED_GOL.includes(p.name))
                                       .sort((a,b) => b[sortKey] - a[sortKey])
                                       .slice(0, info.teams * countPerTeam);
            candidates.sort(() => Math.random() - 0.5).forEach(p => {
                let t = getTargetTeam(p);
                p.assigned = true; t.members.push(p); t.totalScore += p.avg;
            });
        };

        // ë‹¨ê³„ë³„ ë°°ì • (í”½ì†Œ -> ì•„ë¼ -> í”¼ë³´)
        assignStep('fix', 2);
        assignStep('ala', info.perTeam === 6 ? 2 : 1);
        assignStep('piv', 1);

        // ê³¨ë ˆì´ ë° ê³ ì • ì¸ì› ë°°ì • (ì„ì •í˜„, ê¹€í˜„ì›… ë¶„ë¦¬ ë°°ì •)
        let fixedGols = activePool.filter(p => FIXED_GOL.includes(p.name));
        fixedGols.forEach(p => {
            let t = getTargetTeam(p);
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        // ì¼ë°˜ ê³¨ë ˆì´ ë°°ì •
        let remainGols = activePool.filter(p => !p.assigned).sort((a,b) => b.gol - a.gol).slice(0, Math.max(0, info.teams - fixedGols.length));
        remainGols.forEach(p => {
            let t = getTargetTeam(p);
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        // ì‰ì—¬ ì¸ì› ë°°ì •
        activePool.filter(p => !p.assigned).sort((a,b) => b.avg - a.avg).forEach(p => {
            let t = [...teams].filter(v => v.members.length < info.perTeam).sort((a,b) => a.totalScore - b.totalScore)[0];
            if (!t) t = [...teams].sort((a,b) => a.totalScore - b.totalScore)[0];
            p.assigned = true; t.members.push(p); t.totalScore += p.avg;
        });

        display(teams);
    }

    function display(teams) {
        const area = document.getElementById('resultArea'); area.innerHTML = "";
        teams.forEach(t => {
            const card = document.createElement('div'); card.className = 'team-card';
            const mHtml = t.members.map(m => {
                const best = [{n:'GOL',v:m.gol,c:'f6ad55'},{n:'ALA',v:m.ala,c:'4fd1c5'},{n:'FIX',v:m.fix,c:'f687b3'},{n:'PIV',v:m.piv,c:'63b3ed'}].sort((a,b)=>b.v-a.v)[0];
                return `<div class="member-row"><span>${m.name}</span><span class="pos-badge" style="background:#${best.c}">${best.n} ${best.v.toFixed(1)}</span></div>`;
            }).join('');
            card.innerHTML = `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding-bottom:5px; font-weight:800;"><span>TEAM ${t.id}</span><span style="color:var(--primary)">${t.totalScore.toFixed(1)}</span></div>${mHtml}`;
            area.appendChild(card);
        });
    }

    window.onload = loadData;
</script>
</body>
</html>
